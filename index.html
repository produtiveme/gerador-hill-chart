<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Hill Chart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFF9F3;
        }
        h1, h2, h3 {
            font-family: 'Bricolage Grotesque', sans-serif;
        }
        .point-label {
            font-size: 12px;
            fill: #333;
            text-anchor: middle;
            pointer-events: none;
            user-select: none;
            font-family: 'Inter', sans-serif;
        }
        .point-circle {
            cursor: grab;
            transition: r 0.2s ease-in-out, filter 0.2s ease-in-out;
        }
        .point-circle:hover {
            r: 10px;
            filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.3));
        }
        .point-circle:active {
            cursor: grabbing;
        }
        .task-action-btn {
            cursor: pointer;
            color: #9ca3af;
            margin-left: 8px;
            display: inline-block;
            transition: transform 0.2s, color 0.2s;
            font-size: 1.1rem;
        }
        .task-action-btn:hover {
            transform: scale(1.2);
            color: #1f2937;
        }
        .delete-btn:hover {
            color: #ef4444;
        }
        .color-option {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .color-option.selected {
            border-color: #4f46e5;
        }
        /* Estilos do Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Mensagem para Mobile -->
    <div id="mobile-warning" class="lg:hidden flex flex-col items-center justify-center text-center p-8">
        <svg class="w-16 h-16 text-[#FF4E00]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25A2.25 2.25 0 0 1 5.25 3h9.75a2.25 2.25 0 0 1 2.25 2.25Z" />
        </svg>
        <h1 class="text-2xl font-bold mt-4 text-gray-800">Acesso via Desktop</h1>
        <p class="mt-2 text-gray-600">Para a melhor experiência, por favor, utilize um computador para acessar esta aplicação.</p>
    </div>

    <!-- Tela de Login -->
    <div id="login-page" class="w-full max-w-sm mx-auto hidden lg:block">
        <div class="bg-white p-8 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-center text-gray-800">Login</h1>
            <p class="text-center text-gray-500 mt-2">Acesse sua conta para continuar.</p>
            <form id="login-form" class="mt-8 space-y-6">
                <div>
                    <label for="email" class="sr-only">Email</label>
                    <input id="email" name="email" type="email" autocomplete="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FF4E00] focus:border-[#FF4E00]" placeholder="Seu email">
                </div>
                <div>
                    <label for="password" class="sr-only">Senha</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FF4E00] focus:border-[#FF4E00]" placeholder="Sua senha">
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                <div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#FF4E00] hover:bg-[#E64600] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#FF4E00]">
                        Entrar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Tela de Seleção de Projetos -->
    <div id="project-selection-page" class="w-full max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 hidden">
        <div class="flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">Selecione um Projeto</h1>
            <button id="refresh-projects-btn" class="bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">Atualizar Lista</button>
        </div>
        <div id="project-list-loader" class="mt-4 text-center">Carregando projetos...</div>
        <div id="project-list" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Cards de Projeto serão inseridos aqui dinamicamente -->
        </div>
    </div>


    <!-- Conteúdo Principal da Aplicação (visível apenas em Desktop e após login) -->
    <div id="main-app" class="w-full mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 hidden" style="max-width: 1200px;">
        <header class="text-center mb-4 relative">
             <button id="back-to-projects-btn" class="absolute top-0 left-0 bg-gray-200 text-gray-700 font-semibold px-3 py-1 rounded-lg hover:bg-gray-300 transition-colors">&larr; Voltar</button>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Gerador de Hill Chart</h1>
            <p id="project-title-display" class="text-gray-500 mt-2"></p>
        </header>

        <!-- Progresso Total do Projeto -->
        <div class="mb-6 px-1">
            <div class="flex justify-between items-center mb-1">
                <h3 class="text-md font-semibold text-[#6B9E83]">Progresso Total do Projeto (Ponderado)</h3>
                <span id="total-progress-text" class="text-md font-bold text-[#FF4E00]">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="total-progress-bar" class="bg-[#FF4E00] h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- Contêiner do Gráfico -->
        <div id="chart-container" class="relative w-full mb-6 bg-white">
            <svg id="hill-chart-svg" class="w-full" viewBox="0 0 800 350"></svg>
            <div class="flex justify-between mt-2 text-sm md:text-base font-semibold text-gray-600 px-2">
                <span class="text-left w-1/3">Descobrindo a solução<br><span class="font-normal text-gray-500">(Uphill)</span></span>
                <span class="text-center w-1/3 text-[#FF4E00]">Solução conhecida!</span>
                <span class="text-right w-1/3">Executando o trabalho<br><span class="font-normal text-gray-500">(Downhill)</span></span>
            </div>
        </div>

        <!-- Controles -->
        <div class="space-y-4">
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="new-point-label" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FF4E00] focus:border-[#FF4E00] transition" placeholder="Nome da nova funcionalidade...">
                <select id="new-point-complexity" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FF4E00] focus:border-[#FF4E00]">
                    <option value="1">Baixo</option>
                    <option value="3" selected>Médio</option>
                    <option value="5">Alto</option>
                    <option value="7">Muito Alto</option>
                </select>
            </div>
             <div class="flex flex-col sm:flex-row gap-3">
                <button id="add-point-btn" class="w-full sm:w-auto flex-grow bg-[#FF4E00] text-white font-semibold px-6 py-2 rounded-lg hover:bg-[#E64600] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#FF4E00] transition-colors shadow-md">
                    Adicionar Funcionalidade
                </button>
                <button id="update-project-btn" class="w-full sm:w-auto bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors shadow-md">
                    Atualizar no Notion
                </button>
            </div>
            <div class="grid grid-cols-2 lg:grid-cols-3 gap-3">
                 <button id="import-json-btn" class="w-full bg-gray-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors shadow-md">Importar JSON</button>
                 <button id="export-json-btn" class="w-full bg-gray-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors shadow-md">Exportar JSON</button>
                 <button id="export-png-btn" class="w-full bg-[#6B9E83] text-white font-semibold px-4 py-2 rounded-lg hover:bg-[#5A8670] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#6B9E83] transition-colors shadow-md">Exportar PNG</button>
            </div>
        </div>
        
        <!-- Lista de Funcionalidades -->
        <div id="task-list-container" class="mt-6">
            <h3 class="text-lg font-semibold text-[#6B9E83] mb-2">Funcionalidades do Sistema:</h3>
            <ul id="task-list" class="list-none text-gray-600 space-y-1">
            </ul>
        </div>
    </div>
    
    <input type="file" id="import-file-input" class="hidden" accept=".json">

    <footer id="footer" class="text-center mt-8 text-gray-500 text-sm hidden lg:block">
        <p>Versão 3.0.0</p>
    </footer>

    <!-- Modal para Edição de Funcionalidade -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Editar Funcionalidade</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-point-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-point-label" class="block text-sm font-medium text-gray-700">Nome da Funcionalidade</label>
                        <input type="text" id="edit-point-label" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#FF4E00] focus:border-[#FF4E00]">
                    </div>
                     <div>
                        <label for="edit-point-complexity" class="block text-sm font-medium text-gray-700">Complexidade</label>
                        <select id="edit-point-complexity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#FF4E00] focus:border-[#FF4E00]">
                            <option value="1">Baixo</option>
                            <option value="3">Médio</option>
                            <option value="5">Alto</option>
                            <option value="7">Muito Alto</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-point-progress" class="block text-sm font-medium text-gray-700">Progresso (%)</label>
                        <input type="number" id="edit-point-progress" min="0" max="100" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#FF4E00] focus:border-[#FF4E00]">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="close-edit-modal-btn" class="bg-gray-200 text-gray-700 font-semibold px-5 py-2 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
                    <button type="submit" id="save-edit-btn" class="bg-[#FF4E00] text-white font-semibold px-5 py-2 rounded-lg hover:bg-[#E64600] transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elementos Globais e de Navegação ---
            const loginPage = document.getElementById('login-page');
            const projectSelectionPage = document.getElementById('project-selection-page');
            const mainApp = document.getElementById('main-app');
            const footer = document.getElementById('footer');
            const mobileWarning = document.getElementById('mobile-warning');

            // --- Elementos de Login ---
            const loginForm = document.getElementById('login-form');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('login-error');

            // --- Elementos da Seleção de Projetos ---
            const projectList = document.getElementById('project-list');
            const projectListLoader = document.getElementById('project-list-loader');
            const refreshProjectsBtn = document.getElementById('refresh-projects-btn');
            let projectsData = []; // Armazena os dados dos projetos

            // --- Configurações do Gráfico ---
            const svg = document.getElementById('hill-chart-svg');
            const svgNS = "http://www.w3.org/2000/svg";
            const width = 800;
            const height = 350;
            const hillHeight = 150;
            const baseY = 310;
            const hillTopX = width / 2;

            // --- Estado da Aplicação ---
            let points = [];
            let selectedPoint = null;
            let isDragging = false;
            let nextPointId = 0;
            let currentProject = null; // Armazena o objeto do projeto atual

            // --- Elementos da UI da Aplicação Principal ---
            const addPointBtn = document.getElementById('add-point-btn');
            const newPointInput = document.getElementById('new-point-label');
            const newPointComplexity = document.getElementById('new-point-complexity');
            const taskList = document.getElementById('task-list');
            const exportPngBtn = document.getElementById('export-png-btn');
            const exportJsonBtn = document.getElementById('export-json-btn');
            const importJsonBtn = document.getElementById('import-json-btn');
            const importFileInput = document.getElementById('import-file-input');
            const totalProgressBar = document.getElementById('total-progress-bar');
            const totalProgressText = document.getElementById('total-progress-text');
            const backToProjectsBtn = document.getElementById('back-to-projects-btn');
            const projectTitleDisplay = document.getElementById('project-title-display');
            const updateProjectBtn = document.getElementById('update-project-btn');

            // --- Elementos do Modal de Edição ---
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const editPointIdInput = document.getElementById('edit-point-id');
            const editPointLabelInput = document.getElementById('edit-point-label');
            const editPointProgressInput = document.getElementById('edit-point-progress');
            const editPointComplexity = document.getElementById('edit-point-complexity');
            const closeEditModalBtn = document.getElementById('close-edit-modal-btn');


            // --- Funções de Desenho e Lógica ---

            function drawHill() {
                if (!svg) return;
                svg.innerHTML = '';
                const hillFill = document.createElementNS(svgNS, 'path');
                hillFill.setAttribute('d', `M 0 ${baseY} Q ${hillTopX} ${baseY - hillHeight * 2} ${width} ${baseY} Z`);
                hillFill.setAttribute('fill', 'url(#hillGradient)');
                svg.appendChild(hillFill);
                const hillLine = document.createElementNS(svgNS, 'path');
                hillLine.setAttribute('d', `M 0 ${baseY} Q ${hillTopX} ${baseY - hillHeight * 2} ${width} ${baseY}`);
                hillLine.setAttribute('stroke', '#cbd5e1');
                hillLine.setAttribute('stroke-width', '4');
                hillLine.setAttribute('fill', 'none');
                svg.appendChild(hillLine);
                const topMarker = document.createElementNS(svgNS, 'line');
                topMarker.setAttribute('x1', hillTopX);
                topMarker.setAttribute('y1', baseY - hillHeight - 10);
                topMarker.setAttribute('x2', hillTopX);
                topMarker.setAttribute('y2', baseY);
                topMarker.setAttribute('stroke', '#FF4E00');
                topMarker.setAttribute('stroke-width', '2');
                topMarker.setAttribute('stroke-dasharray', '4 4');
                svg.appendChild(topMarker);
                const defs = document.createElementNS(svgNS, 'defs');
                const gradient = document.createElementNS(svgNS, 'linearGradient');
                gradient.id = 'hillGradient';
                gradient.setAttribute('x1', '0%'); gradient.setAttribute('y1', '0%');
                gradient.setAttribute('x2', '0%'); gradient.setAttribute('y2', '100%');
                const stop1 = document.createElementNS(svgNS, 'stop');
                stop1.setAttribute('offset', '0%'); stop1.setAttribute('style', 'stop-color:#f3f4f6;stop-opacity:1');
                const stop2 = document.createElementNS(svgNS, 'stop');
                stop2.setAttribute('offset', '100%'); stop2.setAttribute('style', 'stop-color:#e5e7eb;stop-opacity:1');
                gradient.appendChild(stop1); gradient.appendChild(stop2);
                defs.appendChild(gradient);
                svg.appendChild(defs);
                const pointsGroup = document.createElementNS(svgNS, 'g');
                pointsGroup.id = 'points-group';
                svg.appendChild(pointsGroup);
                const labelsGroup = document.createElementNS(svgNS, 'g');
                labelsGroup.id = 'labels-group';
                svg.appendChild(labelsGroup);
            }

            function getPositionOnHill(progress) {
                const t = progress / 100;
                const p0 = { x: 0, y: baseY };
                const p1 = { x: hillTopX, y: baseY - hillHeight * 2 };
                const p2 = { x: width, y: baseY };
                const x = Math.pow(1 - t, 2) * p0.x + 2 * (1 - t) * t * p1.x + Math.pow(t, 2) * p2.x;
                const y = Math.pow(1 - t, 2) * p0.y + 2 * (1 - t) * t * p1.y + Math.pow(t, 2) * p2.y;
                return { x, y };
            }

            function renderPoints() {
                const pointsGroup = document.getElementById('points-group');
                const labelsGroup = document.getElementById('labels-group');
                if (!pointsGroup || !labelsGroup) return;
                pointsGroup.innerHTML = '';
                labelsGroup.innerHTML = '';
                
                const labelData = [];
                const labelHeight = 15;
                const labelWidthApproximation = 80; // Largura média aproximada de um rótulo

                // 1. Calcular posições iniciais
                points.forEach(point => {
                    const pos = getPositionOnHill(point.progress);
                    labelData.push({
                        id: point.id,
                        point: point,
                        x: pos.x,
                        y: pos.y - 15, // Posição inicial acima do ponto
                        width: labelWidthApproximation,
                        height: labelHeight,
                        pointPos: pos
                    });
                });

                // 2. Algoritmo de Repulsão (simplificado) para evitar sobreposição
                for (let i = 0; i < 5; i++) { // Iterar algumas vezes para estabilizar
                    for (let a = 0; a < labelData.length; a++) {
                        for (let b = a + 1; b < labelData.length; b++) {
                            const labelA = labelData[a];
                            const labelB = labelData[b];

                            // Verificar sobreposição
                            const xOverlap = Math.abs(labelA.x - labelB.x) * 2 < (labelA.width + labelB.width);
                            const yOverlap = Math.abs(labelA.y - labelB.y) * 2 < (labelA.height + labelB.height);

                            if (xOverlap && yOverlap) {
                                // Se sobrepõem, afasta o label B verticalmente
                                labelB.y -= labelHeight;
                            }
                        }
                    }
                }

                // 3. Desenhar pontos, rótulos e linhas guia
                labelData.forEach(data => {
                    // Desenhar ponto
                    const pointGroup = document.createElementNS(svgNS, 'g');
                    pointGroup.setAttribute('transform', `translate(${data.pointPos.x}, ${data.pointPos.y})`);
                    const circle = document.createElementNS(svgNS, 'circle');
                    circle.setAttribute('r', '8');
                    circle.setAttribute('fill', data.point.color);
                    circle.setAttribute('stroke', 'white');
                    circle.setAttribute('stroke-width', '2');
                    circle.setAttribute('class', 'point-circle');
                    circle.dataset.id = data.id;
                    pointGroup.appendChild(circle);
                    pointsGroup.appendChild(pointGroup);

                    // Desenhar rótulo
                    const label = document.createElementNS(svgNS, 'text');
                    label.setAttribute('class', 'point-label');
                    label.setAttribute('x', data.x);
                    label.setAttribute('y', data.y);
                    label.textContent = data.point.label;
                    labelsGroup.appendChild(label);

                    // Desenhar linha guia se o rótulo foi movido
                    if (Math.abs(data.y - (data.pointPos.y - 15)) > 1) {
                         const line = document.createElementNS(svgNS, 'line');
                         line.setAttribute('x1', data.x);
                         line.setAttribute('y1', data.y + 4);
                         line.setAttribute('x2', data.pointPos.x);
                         line.setAttribute('y2', data.pointPos.y - 10); // Conecta um pouco acima do ponto
                         line.setAttribute('stroke', '#9ca3af');
                         line.setAttribute('stroke-width', '1');
                         line.setAttribute('stroke-dasharray', '2 2');
                         labelsGroup.appendChild(line);
                    }
                });

                updateTaskList();
                updateTotalProgress();
            }
            
            function getComplexityTextAndColor(complexityValue) {
                const value = parseInt(complexityValue, 10);
                switch (value) {
                    case 1: return { text: 'Baixo', color: 'bg-green-100 text-green-800' };
                    case 3: return { text: 'Médio', color: 'bg-yellow-100 text-yellow-800' };
                    case 5: return { text: 'Alto', color: 'bg-orange-100 text-orange-800' };
                    case 7: return { text: 'Muito Alto', color: 'bg-red-100 text-red-800' };
                    default: return { text: 'N/D', color: 'bg-gray-100 text-gray-800' };
                }
            }
            
            function mapValueToComplexityText(complexityValue) {
                const value = parseInt(complexityValue, 10);
                switch (value) {
                    case 1: return 'Baixo';
                    case 3: return 'Médio';
                    case 5: return 'Alto';
                    case 7: return 'Muito Alto';
                    default: return 'Médio';
                }
            }

            function getColorForComplexity(complexityValue) {
                const value = parseInt(complexityValue, 10);
                 switch (value) {
                    case 1: return '#6B9E83'; // Cambridge Blue
                    case 3: return '#1D1C1B'; // Eerie Black
                    case 5: return '#FFC280'; // Fawn
                    case 7: return '#FF4E00'; // Aerospace Orange
                    default: return '#9ca3af'; // Gray
                }
            }

            function updateTaskList() {
                if (!taskList) return;
                taskList.innerHTML = '';

                // Ordena uma cópia da lista de pontos
                const sortedPoints = [...points].sort((a, b) => b.progress - a.progress);

                if (sortedPoints.length === 0) {
                    taskList.innerHTML = '<li class="p-1 text-gray-400">Nenhuma funcionalidade adicionada ainda.</li>';
                } else {
                    sortedPoints.forEach(point => {
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between p-2 rounded-md hover:bg-gray-50';
                        li.dataset.id = point.id;

                        const leftSide = document.createElement('div');
                        leftSide.className = 'flex items-center flex-grow';
                        
                        const colorDot = document.createElement('span');
                        colorDot.className = 'w-3 h-3 rounded-full mr-3 flex-shrink-0';
                        colorDot.style.backgroundColor = point.color;

                        const textSpan = document.createElement('span');
                        textSpan.textContent = `${point.label} (${point.progress.toFixed(0)}%)`;
                        textSpan.className = 'flex-grow mr-2';

                        const complexityInfo = getComplexityTextAndColor(point.complexity);
                        const complexityBadge = document.createElement('span');
                        complexityBadge.textContent = complexityInfo.text;
                        complexityBadge.className = `text-xs font-semibold px-2 py-0.5 rounded-full ${complexityInfo.color}`;
                        
                        leftSide.appendChild(colorDot);
                        leftSide.appendChild(textSpan);
                        leftSide.appendChild(complexityBadge);

                        const rightSide = document.createElement('div');
                        rightSide.className = 'flex items-center space-x-3';

                        const editBtn = document.createElement('span');
                        editBtn.className = 'task-action-btn';
                        editBtn.innerHTML = '&#9998;'; // Lápis
                        editBtn.dataset.action = 'edit';

                        const deleteBtn = document.createElement('span');
                        deleteBtn.className = 'task-action-btn delete-btn';
                        deleteBtn.innerHTML = '&#128465;'; // Lixeira
                        deleteBtn.dataset.action = 'delete';
                        
                        rightSide.appendChild(editBtn);
                        rightSide.appendChild(deleteBtn);

                        li.appendChild(leftSide);
                        li.appendChild(rightSide);
                        taskList.appendChild(li);
                    });
                }
            }
            
            function handleTaskListClick(e) {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                
                const action = target.dataset.action;
                const li = target.closest('li');
                const pointId = parseInt(li.dataset.id, 10);
                const point = points.find(p => p.id === pointId);
                if (!point) return;

                switch (action) {
                    case 'delete':
                        if (confirm(`Tem certeza que deseja excluir a funcionalidade "${point.label}"?`)) {
                            points = points.filter(p => p.id !== pointId);
                            renderPoints();
                        }
                        break;
                    case 'edit':
                        openEditModal(point);
                        break;
                }
            }
            
            function updateTotalProgress() {
                if (!totalProgressText || !totalProgressBar) return;
                if (points.length === 0) {
                    totalProgressText.textContent = '0%';
                    totalProgressBar.style.width = '0%';
                    return;
                }

                let totalComplexityPoints = 0;
                let completedComplexityPoints = 0;

                points.forEach(point => {
                    const complexity = point.complexity || 1; // Default para 1 se não definido
                    totalComplexityPoints += complexity;
                    completedComplexityPoints += (point.progress / 100) * complexity;
                });

                const weightedAverage = totalComplexityPoints > 0 ? (completedComplexityPoints / totalComplexityPoints) * 100 : 0;
                
                totalProgressText.textContent = `${weightedAverage.toFixed(0)}%`;
                totalProgressBar.style.width = `${weightedAverage}%`;
            }

            function handleAddPoint() {
                const label = newPointInput.value.trim();
                const complexity = parseInt(newPointComplexity.value, 10);
                const color = getColorForComplexity(complexity);

                if (label) {
                    points.push({
                        id: nextPointId++,
                        label: label,
                        progress: 5,
                        color: color,
                        complexity: complexity,
                        notionId: `new_${Date.now()}` // ID temporário para novos itens
                    });
                    newPointInput.value = '';
                    renderPoints();
                } else {
                    newPointInput.classList.add('border-red-500');
                    setTimeout(() => newPointInput.classList.remove('border-red-500'), 1000);
                }
            }
            
            async function handleExportPng() {
                const originalBtnHTML = exportPngBtn.innerHTML;
                exportPngBtn.disabled = true;
                exportPngBtn.innerHTML = `Exportando...`;
                
                try {
                    // Define tamanhos e espaçamentos
                    const exportWidth = 800;
                    const chartAreaHeight = 380; 
                    const sectionSpacing = 20;
                    const progressBarHeight = 50;
                    const listTitleHeight = 30;
                    const listItemHeight = 22;
                    const footerHeight = 40;

                    // Calcula altura total dinâmica
                    const listHeight = points.length > 0 ? listTitleHeight + (points.length * listItemHeight) : 0;
                    const exportHeight = chartAreaHeight + progressBarHeight + sectionSpacing + listHeight + footerHeight;

                    const exportSvg = document.createElementNS(svgNS, 'svg');
                    exportSvg.setAttribute('xmlns', svgNS);
                    exportSvg.setAttribute('width', exportWidth);
                    exportSvg.setAttribute('height', exportHeight);
                    exportSvg.setAttribute('viewBox', `0 0 ${exportWidth} ${exportHeight}`);
                    
                    const background = document.createElementNS(svgNS, 'rect');
                    background.setAttribute('width', '100%');
                    background.setAttribute('height', '100%');
                    background.setAttribute('fill', 'white');
                    exportSvg.appendChild(background);
                    
                    const cssStyles = document.querySelector('style').textContent;
                    const defs = document.createElementNS(svgNS, 'defs');
                    const style = document.createElementNS(svgNS, 'style');
                    style.textContent = cssStyles;
                    defs.appendChild(style);
                    exportSvg.appendChild(defs);
                    
                    // Adiciona o conteúdo do gráfico
                    const chartGroup = document.createElementNS(svgNS, 'g');
                    chartGroup.innerHTML = svg.innerHTML;
                    exportSvg.appendChild(chartGroup);

                    // Função auxiliar para criar texto
                    const createText = (text, x, y, anchor, weight = 'normal', size = '14px', color = '#333', family = 'Inter, sans-serif') => {
                        const el = document.createElementNS(svgNS, 'text');
                        el.textContent = text;
                        el.setAttribute('x', x);
                        el.setAttribute('y', y);
                        el.setAttribute('text-anchor', anchor);
                        el.setAttribute('font-family', family);
                        el.setAttribute('font-size', size);
                        el.setAttribute('font-weight', weight);
                        el.setAttribute('fill', color);
                        return el;
                    };
                    
                    // Adiciona as legendas do gráfico na posição correta
                    const chartLabelsY = 330;
                    exportSvg.appendChild(createText('Descobrindo a solução', 20, chartLabelsY, 'start', '600', '14px', '#4b5563'));
                    exportSvg.appendChild(createText('(Uphill)', 20, chartLabelsY + 15, 'start', 'normal', '12px', '#6b7280'));
                    
                    exportSvg.appendChild(createText('Solução conhecida!', exportWidth / 2, chartLabelsY, 'middle', '700', '14px', '#FF4E00'));

                    exportSvg.appendChild(createText('Executando o trabalho', exportWidth - 20, chartLabelsY, 'end', '600', '14px', '#4b5563'));
                    exportSvg.appendChild(createText('(Downhill)', exportWidth - 20, chartLabelsY + 15, 'end', 'normal', '12px', '#6b7280'));

                    let currentY = chartAreaHeight;

                    // Adicionar Barra de Progresso Total
                    const totalComplexityPoints = points.reduce((sum, p) => sum + (p.complexity || 1), 0);
                    const completedComplexityPoints = points.reduce((sum, p) => sum + (p.progress / 100) * (p.complexity || 1), 0);
                    const weightedAverage = totalComplexityPoints > 0 ? (completedComplexityPoints / totalComplexityPoints) * 100 : 0;

                    exportSvg.appendChild(createText('Progresso Total do Projeto (Ponderado)', 40, currentY, 'start', '600', '16px', '#6B9E83', 'Bricolage Grotesque, sans-serif'));
                    exportSvg.appendChild(createText(`${weightedAverage.toFixed(0)}%`, exportWidth - 40, currentY, 'end', 'bold', '16px', '#FF4E00'));
                    currentY += 20;
                    const progressBarBg = document.createElementNS(svgNS, 'rect');
                    progressBarBg.setAttribute('x', 40);
                    progressBarBg.setAttribute('y', currentY);
                    progressBarBg.setAttribute('width', exportWidth - 80);
                    progressBarBg.setAttribute('height', 10);
                    progressBarBg.setAttribute('fill', '#e5e7eb');
                    progressBarBg.setAttribute('rx', 5);
                    exportSvg.appendChild(progressBarBg);
                    const progressBarFg = document.createElementNS(svgNS, 'rect');
                    progressBarFg.setAttribute('x', 40);
                    progressBarFg.setAttribute('y', currentY);
                    progressBarFg.setAttribute('width', (exportWidth - 80) * (weightedAverage / 100));
                    progressBarFg.setAttribute('height', 10);
                    progressBarFg.setAttribute('fill', '#FF4E00');
                    progressBarFg.setAttribute('rx', 5);
                    exportSvg.appendChild(progressBarFg);
                    currentY += progressBarHeight;

                    // Adicionar Lista de Funcionalidades
                    if (points.length > 0) {
                        currentY += sectionSpacing;
                        exportSvg.appendChild(createText('Funcionalidades do Sistema:', 40, currentY, 'start', '600', '18px', '#6B9E83', 'Bricolage Grotesque, sans-serif'));
                        currentY += listTitleHeight;
                        const sortedPointsForExport = [...points].sort((a,b) => b.progress - a.progress);
                        sortedPointsForExport.forEach(point => {
                            const colorDot = document.createElementNS(svgNS, 'circle');
                            colorDot.setAttribute('cx', 50);
                            colorDot.setAttribute('cy', currentY - 4);
                            colorDot.setAttribute('r', 5);
                            colorDot.setAttribute('fill', point.color);
                            exportSvg.appendChild(colorDot);
                            const complexityInfo = getComplexityTextAndColor(point.complexity);
                            const fullText = `${point.label} (${point.progress.toFixed(0)}%) - ${complexityInfo.text}`;
                            exportSvg.appendChild(createText(fullText, 65, currentY, 'start'));
                            currentY += listItemHeight;
                        });
                    }
                    
                    // Adicionar Rodapé
                    const footerText = createText('www.produtive.me', exportWidth / 2, exportHeight - 20, 'middle', '400', '12px', '#9ca3af');
                    exportSvg.appendChild(footerText);

                    const svgString = new XMLSerializer().serializeToString(exportSvg);
                    const svgDataUrl = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
                    
                    await new Promise((resolve, reject) => {
                        const img = new Image();
                        img.src = svgDataUrl;
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            canvas.width = exportWidth;
                            canvas.height = exportHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            const pngDataUrl = canvas.toDataURL('image/png');
                            const downloadLink = document.createElement('a');
                            downloadLink.href = pngDataUrl;
                            downloadLink.download = 'hc_produtiveme.png';
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                            document.body.removeChild(downloadLink);
                            resolve();
                        };
                        img.onerror = reject;
                    });
                } catch (error) {
                    console.error("Falha ao exportar o gráfico:", error);
                } finally {
                    exportPngBtn.disabled = false;
                    exportPngBtn.innerHTML = `Exportar PNG`;
                }
            }
            
            function handleExportJson() {
                if (points.length === 0) {
                    alert("Não há nada para exportar. Adicione algumas funcionalidades primeiro.");
                    return;
                }
                const jsonString = JSON.stringify(points, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'hc_produtiveme.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function handleImportJson() {
                importFileInput.click();
            }

            function handleFileSelect(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (Array.isArray(importedData) && (importedData.length === 0 || (importedData[0].id !== undefined && importedData[0].label && importedData[0].progress !== undefined))) {
                            importedData.forEach(p => { 
                                if (p.complexity === undefined) p.complexity = 3;
                                p.color = getColorForComplexity(p.complexity);
                            });
                            points = importedData;
                            nextPointId = points.length > 0 ? Math.max(...points.map(p => p.id)) + 1 : 0;
                            renderPoints();
                        } else {
                            alert("Arquivo JSON inválido ou formato incorreto.");
                        }
                    } catch (error) {
                        alert("Erro ao ler o arquivo JSON. Verifique se o arquivo está formatado corretamente.");
                        console.error("Erro no parse do JSON:", error);
                    }
                };
                reader.readAsText(file);
                e.target.value = null;
            }


            function onMouseDown(e) {
                if (e.target.classList.contains('point-circle')) {
                    selectedPoint = points.find(p => p.id == e.target.dataset.id);
                    if (selectedPoint) { isDragging = true; e.target.style.cursor = 'grabbing'; }
                }
            }

            function onMouseMove(e) {
                if (!isDragging || !selectedPoint) return;
                e.preventDefault();
                const svgRect = svg.getBoundingClientRect();
                const mouseX = e.clientX - svgRect.left;
                let progress = (mouseX / svgRect.width) * 100;
                progress = Math.max(0, Math.min(100, progress));
                selectedPoint.progress = progress;
                renderPoints();
            }

            function onMouseUp() { if (isDragging) { isDragging = false; selectedPoint = null; renderPoints(); } }
            
            function onMouseLeave() { if (isDragging) { onMouseUp(); } }
            
            async function handleLogin(e) {
                e.preventDefault();
                const email = emailInput.value;
                const password = passwordInput.value;
                const loginButton = e.target.querySelector('button');

                loginError.classList.add('hidden');
                loginButton.disabled = true;
                loginButton.textContent = 'Entrando...';

                const n8nWebhookUrl = 'https://work.produ-cloud.com/webhook/hillchartlogin'; 

                try {
                    const response = await fetch(n8nWebhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password }),
                    });

                    if (!response.ok) throw new Error('Falha na autenticação ou erro no servidor.');
                    const data = await response.json();

                    if (data.success === true) {
                        loginPage.style.display = 'none';
                        projectSelectionPage.style.display = 'block';
                        await loadProjects();
                    } else {
                        loginError.textContent = data.message || 'Email ou senha inválidos.';
                        loginError.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Erro ao conectar com o servidor de autenticação:', error);
                    loginError.textContent = 'Erro de conexão. Tente novamente.';
                    loginError.classList.remove('hidden');
                } finally {
                    loginButton.disabled = false;
                    loginButton.textContent = 'Entrar';
                }
            }

            async function loadProjects() {
                const n8nProjectsUrl = 'https://work.produ-cloud.com/webhook/hillchart_carrega_projeto';
                
                projectList.innerHTML = '';
                projectListLoader.style.display = 'block';

                try {
                    const response = await fetch(n8nProjectsUrl);
                    if (!response.ok) throw new Error('Não foi possível carregar os projetos.');
                    const rawProjectsData = await response.json();

                    projectsData = rawProjectsData.map(project => ({
                        projectName: project.Nome_Projeto,
                        projectId: project.ID_Notion_Projeto,
                        deadline: project.Prazo_Final_Projeto,
                        system: project.Sistema_Projeto,
                        progress: project.Progresso,
                    }));

                    projectListLoader.style.display = 'none';
                    if (projectsData.length === 0) {
                        projectList.innerHTML = '<div>Nenhum projeto encontrado.</div>';
                        return;
                    }
                    
                    projectList.innerHTML = ''; // Clear previous list
                    projectsData.forEach((project, index) => {
                        const today = new Date();
                        const deadlineDate = new Date(project.deadline);
                        const timeDiff = deadlineDate.getTime() - today.getTime();
                        const daysRemaining = Math.max(0, Math.ceil(timeDiff / (1000 * 3600 * 24)));

                        const card = `
                            <div data-index="${index}" class="project-card bg-gray-50 p-4 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors border">
                                <h3 class="font-bold text-lg text-gray-800">${project.projectName}</h3>
                                <div class="flex justify-between items-center mt-2 text-sm">
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">${project.system}</span>
                                    <span class="font-semibold ${daysRemaining < 15 ? 'text-red-500' : 'text-gray-600'}">${daysRemaining} dias restantes</span>
                                </div>
                                <div class="mt-3">
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm font-medium text-gray-700">Progresso</span>
                                        <span class="text-sm font-medium text-[#FF4E00]">${project.progress}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-[#FF4E00] h-2 rounded-full" style="width: ${project.progress}%"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                        projectList.innerHTML += card;
                    });

                } catch (error) {
                    console.error('Erro ao carregar projetos:', error);
                    projectListLoader.style.display = 'none';
                    projectList.innerHTML = '<div>Ocorreu um erro ao carregar os projetos.</div>';
                }
            }
            
            function mapComplexityToValue(complexityText) {
                const map = {
                    "baixo": 1,
                    "médio": 3,
                    "medio": 3,
                    "alto": 5,
                    "muito alto": 7
                };
                return map[complexityText.toLowerCase()] || 3; // Default to Medium
            }

            async function loadFunctionalities(projectId) {
                projectSelectionPage.style.display = 'none';
                mainApp.style.display = 'block';
                footer.style.display = 'block';
                
                taskList.innerHTML = '<li class="p-1 text-gray-400">Carregando funcionalidades...</li>';
                points = []; // Limpa os pontos do projeto anterior
                renderPoints();

                const n8nFuncsUrl = 'https://work.produ-cloud.com/webhook/hillchart_carrega_projeto';

                try {
                    const response = await fetch(n8nFuncsUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ projectId: projectId })
                    });
                    if (!response.ok) throw new Error('Não foi possível carregar as funcionalidades.');
                    
                    const funcsData = await response.json();
                    
                    points = funcsData.map((func, index) => {
                        const complexity = mapComplexityToValue(func.Complexidade);
                        return {
                            id: index, // ID local para manipulação
                            label: func.Nome_Funcionalidade,
                            progress: func.Progresso,
                            complexity: complexity,
                            color: getColorForComplexity(complexity),
                            description: func.Descricao,
                            notionId: func.ID_Funcionalidade_Notion
                        };
                    });
                    
                    nextPointId = points.length;
                    renderPoints();

                } catch (error) {
                    alert("Erro ao carregar as funcionalidades do projeto.");
                    console.error("Erro ao buscar funcionalidades:", error);
                    showProjectSelection();
                }
            }

            function handleProjectSelection(e) {
                const card = e.target.closest('.project-card');
                if (card) {
                    const projectIndex = card.dataset.index;
                    currentProject = projectsData[projectIndex];
                    projectTitleDisplay.textContent = currentProject.projectName;
                    
                    points = [];
                    renderPoints();
                    
                    loadFunctionalities(currentProject.projectId);
                }
            }

            async function handleUpdateProject() {
                if (!currentProject) {
                    alert("Nenhum projeto selecionado para atualizar.");
                    return;
                }

                const originalBtnHTML = updateProjectBtn.innerHTML;
                updateProjectBtn.disabled = true;
                updateProjectBtn.innerHTML = 'Atualizando...';

                const n8nUpdateUrl = 'https://work.produ-cloud.com/webhook/atualiza_registro_notion';
                
                const totalComplexityPoints = points.reduce((sum, p) => sum + (p.complexity || 1), 0);
                const completedComplexityPoints = points.reduce((sum, p) => sum + (p.progress / 100) * (p.complexity || 1), 0);
                const weightedAverage = totalComplexityPoints > 0 ? (completedComplexityPoints / totalComplexityPoints) * 100 : 0;

                const payload = points.map(p => ({
                    "ID_Projeto": currentProject.projectId,
                    "ID_Funcionalidade": p.notionId,
                    "Nome": p.label,
                    "Complexidade": mapValueToComplexityText(p.complexity),
                    "Progresso": p.progress,
                    "Conclusao_Projeto": Math.round(weightedAverage)
                }));

                try {
                    const response = await fetch(n8nUpdateUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (response.ok) {
                        updateProjectBtn.innerHTML = 'Atualizado!';
                        setTimeout(() => { updateProjectBtn.innerHTML = 'Atualizar no Notion'; }, 2000);
                    } else {
                        const errorData = await response.json().catch(() => null);
                        throw new Error(errorData?.message || 'Falha ao atualizar o projeto no servidor.');
                    }

                } catch (error) {
                    console.error('Erro ao atualizar projeto:', error);
                    alert(`Erro ao atualizar: ${error.message}`);
                    updateProjectBtn.innerHTML = 'Falhou!';
                     setTimeout(() => { updateProjectBtn.innerHTML = 'Atualizar no Notion'; }, 3000);
                } finally {
                    updateProjectBtn.disabled = false;
                }
            }
            
            function showProjectSelection() {
                mainApp.style.display = 'none';
                footer.style.display = 'none';
                projectSelectionPage.style.display = 'block';
                currentProject = null;
                loadProjects();
            }

            function openEditModal(point) {
                editPointIdInput.value = point.id;
                editPointLabelInput.value = point.label;
                editPointProgressInput.value = point.progress.toFixed(0);
                editPointComplexity.value = point.complexity || 3;
                editModal.classList.add('visible');
            }

            function handleSaveEdit(e) {
                e.preventDefault();
                const pointId = parseInt(editPointIdInput.value, 10);
                const point = points.find(p => p.id === pointId);
                if (!point) return;

                const newLabel = editPointLabelInput.value.trim();
                const newProgress = parseFloat(editPointProgressInput.value);
                const newComplexity = parseInt(editPointComplexity.value, 10);

                if (newLabel === '') {
                    alert('O nome da funcionalidade não pode ser vazio.');
                    return;
                }
                if (isNaN(newProgress) || newProgress < 0 || newProgress > 100) {
                    alert('O progresso deve ser um número entre 0 e 100.');
                    return;
                }

                point.label = newLabel;
                point.progress = newProgress;
                point.color = getColorForComplexity(newComplexity);
                point.complexity = newComplexity;

                renderPoints();
                editModal.classList.remove('visible');
            }

            function initializeMainApp() {
                drawHill();
                renderPoints();
                addPointBtn.addEventListener('click', handleAddPoint);
                newPointInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { handleAddPoint(); } });
                exportPngBtn.addEventListener('click', handleExportPng);
                exportJsonBtn.addEventListener('click', handleExportJson);
                importJsonBtn.addEventListener('click', handleImportJson);
                importFileInput.addEventListener('change', handleFileSelect);
                taskList.addEventListener('click', handleTaskListClick);
                updateProjectBtn.addEventListener('click', handleUpdateProject);
                
                editForm.addEventListener('submit', handleSaveEdit);
                closeEditModalBtn.addEventListener('click', () => editModal.classList.remove('visible'));

                svg.addEventListener('mousedown', onMouseDown);
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                svg.addEventListener('mouseleave', onMouseLeave);
            }
            
            function pageLoad() {
                if (window.innerWidth < 1024) {
                    mobileWarning.classList.remove('hidden');
                    loginPage.style.display = 'none';
                } else {
                    mobileWarning.classList.add('hidden');
                    loginPage.style.display = 'block';
                    loginForm.addEventListener('submit', handleLogin);
                    projectList.addEventListener('click', handleProjectSelection);
                    backToProjectsBtn.addEventListener('click', showProjectSelection);
                    refreshProjectsBtn.addEventListener('click', loadProjects);
                    initializeMainApp();
                }
            }

            pageLoad();
        });
    </script>
</body>
</html>
